<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UNC Markets</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --ink:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(11,18,32,.10);
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;
      --accent:#2563eb;
      --shadow: 0 14px 40px rgba(2,6,23,.10);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 10% -10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(800px 480px at 90% 0%, rgba(22,163,74,.12), transparent 55%),
        radial-gradient(700px 600px at 60% 110%, rgba(245,158,11,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 120px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(10px);
      border-radius: 22px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 5;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.7), transparent 60%),
        linear-gradient(140deg, rgba(22,163,74,1), rgba(37,99,235,1));
      box-shadow: 0 12px 30px rgba(2,6,23,.20);
      border:1px solid rgba(255,255,255,.9);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      border-radius: 999px;
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;
    }
    .balance{font-weight:900;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      color:var(--ink);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:800;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:#fff}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:rgba(37,99,235,.28);background:rgba(37,99,235,.10)}
    .btn.good{border-color:rgba(22,163,74,.28);background:rgba(22,163,74,.10)}
    .btn.danger{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.08)}
    .btn.ghost{background:transparent}
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr} header{position:static}}
    .card{
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(11,18,32,.06);
      background:
        radial-gradient(900px 180px at 10% 0%, rgba(22,163,74,.08), transparent 60%),
        rgba(255,255,255,.35);
    }
    .card h2{margin:0;font-size:13px;letter-spacing:.2px}
    .card .sub{font-size:12px;margin-top:6px;color:var(--muted);line-height:1.35}
    .card .bd{padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.95);
      color:var(--ink);
      outline:none;
    }
    textarea{min-height:78px;resize:vertical}
    .split{display:flex;gap:10px}
    .split > *{flex:1}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .markets{display:flex;flex-direction:column;gap:12px}
    .market{
      border:1px solid rgba(11,18,32,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.9);
      overflow:hidden;
    }
    .marketTop{
      padding:14px;
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
      border-bottom:1px solid rgba(11,18,32,.06);
    }
    .mTitle{margin:0;font-weight:950;letter-spacing:.2px;font-size:14px;line-height:1.25}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:var(--muted);align-items:center}
    .badge{
      border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.9);
      padding:4px 10px;
      border-radius:999px;
    }
    .badge.good{border-color:rgba(22,163,74,.22);background:rgba(22,163,74,.08)}
    .badge.bad{border-color:rgba(220,38,38,.22);background:rgba(220,38,38,.06)}
    .badge.warn{border-color:rgba(245,158,11,.22);background:rgba(245,158,11,.10)}
    .desc{margin-top:10px;color:rgba(11,18,32,.74);font-size:12px;line-height:1.45}
    .marketMid{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width:720px){.marketMid{grid-template-columns:1fr}}
    .side{
      border:1px solid rgba(11,18,32,.08);
      border-radius:16px;
      padding:12px;
      background: rgba(246,248,251,.8);
    }
    .side h3{margin:0 0 6px;font-size:13px}
    .stat{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}
    .stat b{color:rgba(11,18,32,.92);font-weight:900}
    .price{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.10);
      overflow:hidden;
      height:10px;
      background: rgba(11,18,32,.06);
    }
    .price > div{height:100%}
    .betRow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .betRow input{max-width:170px}
    .marketFoot{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-top:1px solid rgba(11,18,32,.06);
      background: rgba(246,248,251,.6);
      flex-wrap:wrap;
    }
    .note{font-size:12px;color:var(--muted);line-height:1.35}
    .rightcol .card{position:sticky;top:88px}
    @media(max-width:980px){.rightcol .card{position:static}}
    .ticker{
      display:flex;gap:10px;align-items:center;overflow:hidden;
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 18px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      margin-top:14px;
    }
    .tick{
      display:flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.9);
      white-space:nowrap;
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
    .dot.red{background:var(--bad)}
    .dot.amber{background:var(--warn)}
    .footer{
      margin-top:16px;
      font-size:12px;
      color:rgba(11,18,32,.55);
      text-align:center;
      line-height:1.4;
    }

    /* Security question toast (no hints, no admin mention) */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: min(380px, calc(100vw - 28px));
      border-radius: 18px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 60px rgba(2,6,23,.20);
      overflow:hidden;
      z-index: 50;
    }
    .toast .tHd{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid rgba(11,18,32,.08);
    }
    .toast .tHd b{font-size:13px}
    .toast .tBd{padding:12px 14px}
    .toast .tBd p{margin:0 0 10px;font-size:12px;color:var(--muted);line-height:1.35}
    .toast.hide{display:none}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(11,18,32,.14);
      background: rgba(11,18,32,.04);
      color: rgba(11,18,32,.78);
    }

    .skeleton{
      border-radius:16px;
      background: linear-gradient(90deg, rgba(11,18,32,.05), rgba(11,18,32,.09), rgba(11,18,32,.05));
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>UNC Markets</h1>
          <div class="sub">Operated by the Government of UNC’s Luxembourg Ronation.</div>
        </div>
      </div>
      <div class="topbar">
        <div class="pill">
          <span class="muted">UNC Bucks</span>
          <span class="balance" id="balance">—</span>
        </div>
        <button class="btn primary" id="newBtn">Create Prediction</button>
      </div>
    </header>

    <div class="ticker" id="ticker">
      <div class="tick"><span class="dot"></span><b id="tOpen">—</b><span class="muted">open</span></div>
      <div class="tick"><span class="dot amber"></span><b id="tOverdue">—</b><span class="muted">overdue</span></div>
      <div class="tick"><span class="dot red"></span><b id="tResolved">—</b><span class="muted">resolved</span></div>
      <div class="tick"><span class="muted">Treasury</span><b id="tTreasury">—</b></div>
      <div style="flex:1"></div>
      <div class="tick"><span class="muted">ID</span><span class="kbd" id="tId">—</span></div>
    </div>

    <div class="grid">
      <div class="leftcol">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Markets</h2>
              <div class="sub">Create up to 3 open predictions per IP. Creating or deleting your own prediction costs 10 UNC Bucks.</div>
            </div>
            <div class="row">
              <span class="badge" id="statusBadge">Online</span>
            </div>
          </div>
          <div class="bd">
            <div id="markets" class="markets"></div>
            <div id="empty" class="muted" style="display:none;padding:10px 2px;font-size:12px">
              No predictions yet.
            </div>
          </div>
        </div>

        <div class="footer">
          The platform is run by the <b>Government of UNC’s Luxembourg Ronation</b>.
        </div>
      </div>

      <div class="rightcol">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Create / Details</h2>
              <div class="sub">Define clear resolution criteria and a time span.</div>
            </div>
          </div>
          <div class="bd">
            <div id="createBox" style="display:none">
              <label>Title</label>
              <input id="cTitle" maxlength="120" placeholder="e.g. Germany attacks the Falklands!" />

              <label>Clarification / What counts as true?</label>
              <textarea id="cDesc" maxlength="900" placeholder="Define the win condition clearly."></textarea>

              <div class="split">
                <div>
                  <label>Time span (days)</label>
                  <input id="cDays" type="number" min="1" max="365" value="20" />
                </div>
                <div>
                  <label>Category</label>
                  <select id="cCat">
                    <option>Geopolitics</option>
                    <option>UNC Affairs</option>
                    <option>Economy</option>
                    <option>Space & Science</option>
                    <option>Culture</option>
                    <option>Other</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:12px">
                <button class="btn good" id="createBtn">Create</button>
                <button class="btn" id="cancelCreate">Cancel</button>
              </div>

              <div class="note" style="margin-top:12px">
                Bets are pooled YES vs NO. When resolved, the losing pool is distributed to winners proportional to their stake.
              </div>
            </div>

            <div id="infoBox">
              <div class="note">
                • Everyone starts with 1000 UNC Bucks.<br>
                • Bet YES/NO on any market (including your own).<br>
                • Markets are resolved when they are due (and can resolve earlier if needed).<br>
                • Creating or deleting your own market costs 10 UNC Bucks.
              </div>
            </div>

            <div id="adminBox" style="display:none;margin-top:12px;padding:12px;border-radius:16px;border:1px solid rgba(245,158,11,.22);background:rgba(245,158,11,.10)">
              <b style="font-size:13px">Administration</b>
              <div class="note" style="margin-top:6px">
                Tools for resolving overdue markets and enforcing rules are enabled for this session.
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Question Toast (no hints shown) -->
  <div id="toast" class="toast">
    <div class="tHd">
      <b>Security Question</b>
      <button class="btn ghost" id="toastClose" style="padding:8px 10px;border-radius:12px">×</button>
    </div>
    <div class="tBd">
      <p id="toastQ">—</p>
      <input id="toastA" placeholder="Answer (optional)"/>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="toastOk">Submit</button>
        <span class="muted" style="font-size:12px">You can close this.</span>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const marketsEl = $("markets");
  const emptyEl = $("empty");
  const balanceEl = $("balance");
  const statusBadge = $("statusBadge");

  const tOpen = $("tOpen");
  const tOverdue = $("tOverdue");
  const tResolved = $("tResolved");
  const tTreasury = $("tTreasury");
  const tId = $("tId");

  const newBtn = $("newBtn");
  const createBox = $("createBox");
  const infoBox = $("infoBox");
  const adminBox = $("adminBox");

  const createBtn = $("createBtn");
  const cancelCreate = $("cancelCreate");
  const cTitle = $("cTitle");
  const cDesc = $("cDesc");
  const cDays = $("cDays");
  const cCat = $("cCat");

  const toast = $("toast");
  const toastQ = $("toastQ");
  const toastA = $("toastA");
  const toastOk = $("toastOk");
  const toastClose = $("toastClose");

  const QUESTIONS = [
    "What is your favorite committee name?",
    "If treaties had a scent, what would this one smell like?",
    "How many stamps are required for an urgent form?",
    "Name a completely fictional ministerial department.",
    "What is the most efficient bureaucracy-shaped animal?"
  ];

  const fmt = (n) => (Math.round(n * 100) / 100).toLocaleString(undefined, { maximumFractionDigits: 2 });
  const escapeHtml = (str) => String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function showCreate(on){
    createBox.style.display = on ? "block" : "none";
    infoBox.style.display = on ? "none" : "block";
  }

  function toastMaybeShow(){
    if (sessionStorage.getItem("unc_toast_seen") === "1") return;
    sessionStorage.setItem("unc_toast_seen", "1");
    toastQ.textContent = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
    toast.classList.remove("hide");
    setTimeout(() => toastA.focus(), 200);
  }
  function toastHide(){ toast.classList.add("hide"); }

  async function api(path, options){
    const res = await fetch(path, {
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      ...options
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : ("Request failed (" + res.status + ")");
      throw new Error(msg);
    }
    return data;
  }

  function skeletonMarkets(){
    marketsEl.innerHTML = "";
    for (let i=0;i<3;i++){
      const d = document.createElement("div");
      d.className = "market";
      d.innerHTML = `
        <div class="marketTop">
          <div style="flex:1">
            <div class="skeleton" style="height:14px;width:70%"></div>
            <div style="height:10px"></div>
            <div class="skeleton" style="height:10px;width:55%"></div>
          </div>
          <div class="skeleton" style="height:32px;width:120px;border-radius:14px"></div>
        </div>
        <div class="marketMid">
          <div class="side"><div class="skeleton" style="height:12px;width:40%"></div><div style="height:10px"></div><div class="skeleton" style="height:10px;width:60%"></div></div>
          <div class="side"><div class="skeleton" style="height:12px;width:40%"></div><div style="height:10px"></div><div class="skeleton" style="height:10px;width:60%"></div></div>
        </div>`;
      marketsEl.appendChild(d);
    }
  }

  function daysLeftLabel(deadlineAt){
    const ms = deadlineAt - Date.now();
    if (ms <= 0) return "Overdue";
    const d = ms / (1000*60*60*24);
    if (d < 1) return "Less than 1 day";
    return `${Math.ceil(d)} day(s) left`;
  }

  function priceBar(yesPct){
    const g = Math.max(0, Math.min(100, yesPct));
    return `
      <div class="price" title="YES share of pool">
        <div style="width:${g}%;background:rgba(22,163,74,.85)"></div>
      </div>`;
  }

  function render({ me, markets, treasury, isAdmin }){
    balanceEl.textContent = fmt(me.balance);
    tId.textContent = me.key;
    tTreasury.textContent = fmt(treasury);

    adminBox.style.display = isAdmin ? "block" : "none";

    const open = markets.filter(m => m.status === "open").length;
    const resolved = markets.filter(m => m.status === "resolved").length;
    const overdue = markets.filter(m => m.status === "open" && (Date.now() > m.deadlineAt)).length;

    tOpen.textContent = open;
    tResolved.textContent = resolved;
    tOverdue.textContent = overdue;

    marketsEl.innerHTML = "";
    emptyEl.style.display = markets.length ? "none" : "block";

    for (const m of markets){
      const overdueNow = (m.status === "open" && Date.now() > m.deadlineAt);

      const total = (m.pools.yes + m.pools.no) || 0;
      const yesPct = total > 0 ? (m.pools.yes / total) * 100 : 50;
      const noPct = 100 - yesPct;

      const statusBadgeHtml =
        m.status === "resolved"
          ? `<span class="badge ${m.outcome === "YES" ? "good" : "bad"}">Resolved: ${m.outcome}</span>`
          : overdueNow
            ? `<span class="badge warn">Overdue</span>`
            : `<span class="badge">Open</span>`;

      const creatorMark = m.isCreator ? `<span class="badge">Creator</span>` : "";

      // IMPORTANT: admin controls only injected if isAdmin === true
      const adminControls = isAdmin ? `
        <div class="row" style="gap:8px;margin-top:10px;flex-wrap:wrap">
          ${m.status === "open" ? `
            <button class="btn good" data-act="resolveYes" data-id="${m.id}">Resolve TRUE</button>
            <button class="btn danger" data-act="resolveNo" data-id="${m.id}">Resolve FALSE</button>
          ` : ``}
          <button class="btn danger" data-act="forceDelete" data-id="${m.id}">Force Delete</button>
          <button class="btn" data-act="banCreator" data-id="${m.id}">Ban Creator</button>
        </div>
      ` : ``;

      const ownerDelete = (m.status === "open" && m.isCreator) ? `
        <button class="btn danger" data-act="delete" data-id="${m.id}">Delete</button>
      ` : ``;

      const betControls = (m.status === "open") ? `
        <div class="betRow">
          <input type="number" min="1" step="1" placeholder="Amount" data-bet-amt="${m.id}" />
          <button class="btn good" data-act="betYes" data-id="${m.id}">YES</button>
          <button class="btn danger" data-act="betNo" data-id="${m.id}">NO</button>
        </div>
      ` : ``;

      const note = (m.status === "resolved")
        ? `Market resolved.`
        : overdueNow
          ? `Overdue.`
          : `Deadline: ${daysLeftLabel(m.deadlineAt)}.`;

      const el = document.createElement("div");
      el.className = "market";
      el.innerHTML = `
        <div class="marketTop">
          <div style="min-width:0">
            <div class="mTitle">${escapeHtml(m.title)}</div>
            <div class="meta">
              ${statusBadgeHtml}
              <span class="badge">${escapeHtml(m.category)}</span>
              ${creatorMark}
              <span class="badge">Created: ${escapeHtml(m.createdAtHuman)}</span>
              <span class="badge">Deadline: ${escapeHtml(m.deadlineAtHuman)}</span>
            </div>
            <div class="desc">${escapeHtml(m.desc)}</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            ${ownerDelete}
          </div>
        </div>

        <div class="marketMid">
          <div class="side">
            <h3>YES</h3>
            <div class="stat"><span>Pool</span><b>${fmt(m.pools.yes)}</b></div>
            <div class="stat"><span>Share</span><b>${fmt(yesPct)}%</b></div>
            <div class="stat"><span>Your stake</span><b>${fmt(m.me.yes)}</b></div>
            ${priceBar(yesPct)}
          </div>

          <div class="side">
            <h3>NO</h3>
            <div class="stat"><span>Pool</span><b>${fmt(m.pools.no)}</b></div>
            <div class="stat"><span>Share</span><b>${fmt(noPct)}%</b></div>
            <div class="stat"><span>Your stake</span><b>${fmt(m.me.no)}</b></div>
            ${priceBar(100-yesPct)}
          </div>
        </div>

        <div class="marketFoot">
          <div class="note">${escapeHtml(note)}</div>
          <div style="flex:1"></div>
          <div style="min-width:320px;max-width:520px">
            ${betControls}
            ${isAdmin ? adminControls : ""}
          </div>
        </div>
      `;
      marketsEl.appendChild(el);
    }

    statusBadge.textContent = "Online";
  }

  async function refresh(){
    statusBadge.textContent = "Syncing…";
    const data = await api("/api/bootstrap", { method: "GET" });
    render(data);
  }

  async function createPrediction(){
    const title = cTitle.value.trim();
    const desc = cDesc.value.trim();
    const days = parseInt(cDays.value, 10);

    if (!title) return alert("Please enter a title.");
    if (!desc) return alert("Please add a clarification.");
    if (!Number.isFinite(days) || days < 1 || days > 365) return alert("Time span must be 1–365 days.");

    await api("/api/create", {
      method: "POST",
      body: JSON.stringify({ title, desc, days, category: cCat.value })
    });

    cTitle.value = "";
    cDesc.value = "";
    cDays.value = "20";
    cCat.value = "Geopolitics";
    showCreate(false);
    await refresh();
  }

  async function handleMarketClick(ev){
    const btn = ev.target.closest("button");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");
    if (!act || !id) return;

    if (act === "delete") {
      if (!confirm("Delete this prediction?")) return;
      await api("/api/delete", { method:"POST", body: JSON.stringify({ id }) });
      return refresh();
    }

    if (act === "forceDelete") {
      if (!confirm("Force delete this prediction?")) return;
      await api("/api/delete", { method:"POST", body: JSON.stringify({ id, force:true }) });
      return refresh();
    }

    if (act === "betYes" || act === "betNo") {
      const amtInput = marketsEl.querySelector(`input[data-bet-amt="${CSS.escape(id)}"]`);
      const amt = amtInput ? amtInput.value : "";
      if (!amtInput) return;
      amtInput.value = "";
      await api("/api/bet", {
        method:"POST",
        body: JSON.stringify({ id, outcome: act === "betYes" ? "YES" : "NO", amount: Number(amt) })
      });
      return refresh();
    }

    if (act === "resolveYes" || act === "resolveNo") {
      await api("/api/admin/resolve", {
        method:"POST",
        body: JSON.stringify({ id, outcome: act === "resolveYes" ? "YES" : "NO" })
      });
      return refresh();
    }

    if (act === "banCreator") {
      await api("/api/admin/ban", { method:"POST", body: JSON.stringify({ id }) });
      return refresh();
    }
  }

  async function submitSecurityAnswer(){
    const answer = (toastA.value || "").trim();
    toastHide();
    // Always submit; server may set an admin cookie silently if answer matches secret.
    try{
      await api("/api/security", { method:"POST", body: JSON.stringify({ answer }) });
    }catch{
      // ignore
    }
    // Refresh to reflect possible new privileges
    await refresh();
  }

  // UI events
  newBtn.addEventListener("click", () => { showCreate(true); setTimeout(() => cTitle.focus(), 50); });
  cancelCreate.addEventListener("click", () => showCreate(false));
  createBtn.addEventListener("click", () => createPrediction().catch(e => alert(e.message)));
  marketsEl.addEventListener("click", (ev) => { handleMarketClick(ev).catch(e => alert(e.message)); });

  toastClose.addEventListener("click", () => toastHide());
  toastOk.addEventListener("click", () => submitSecurityAnswer());
  toastA.addEventListener("keydown", (e) => { if (e.key === "Enter") submitSecurityAnswer(); });

  // Boot
  skeletonMarkets();
  refresh().catch(e => { statusBadge.textContent="Offline"; alert(e.message); });
  toastMaybeShow();
})();
</script>
</body>
</html>